{% extends "index.html" %}
{% block addmodal %}
<div class="modal fade" id="CreateRoomModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content modal-info">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body modal-spa">
                <div class="sign-grids">
                    <div class="sign">
                        <div class="sign-left">
                            <ul>
                                <li><a class="fb" href="#"><i></i>Nhắn Tin</a></li>
                                <li><a class="goog" href="#"><i></i>Nghe Nhạc</a></li>
                                <li><a class="linkin" href="#"><i></i>Hãy Làm Người Kết Nối</a></li>
                            </ul>
                            <!--<div id="alert_placeholder"></div>-->
                        </div>
                        <div class="sign-right">
                            <form name="createroomform" id="createroomformid" method='POST'>
                                <input type="text" id="roomnameid" name="roomname" value="Nhập Tên Phòng"
                                    onfocus="this.value = '';"
                                    onblur="if (this.value == '') {this.value = 'Nhập Tên Phòng';}" required="">
                                <input type="text" id="topicid" name="topic" value="Nhập Chủ Đề"
                                    onfocus="this.value = '';"
                                    onblur="if (this.value == '') {this.value = 'Nhập Chủ Đề';}" required="">
                                <input type="password" id="roompasswordid" name="roompassword"
                                    value="Nhập Password Phòng" onfocus="this.value = '';"
                                    onblur="if (this.value == '') {this.value = 'Nhập Password Phòng';}" required="">

                                <input id="createroom" type="submit" value="Tạo Phòng">

                            </form>

                        </div>
                        <div class="clearfix"></div>
                    </div>
                    <p>Nhấn vào nút <span>Tạo phòng</span> đồng nghĩa với bạn đã đồng ý với <span>điều khoản sử
                            dụng</span> của
                        chúng tôi</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!---Model login-->
<div class="modal" id="ModalLogin">
    <div class="modal-dialog">
      <div class="modal-content">
      
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title" id ="loginroomtitle"></h4>
        </div>
        
        <!-- Modal body -->
        <div class="modal-body">
          <form name="loginroom" id="loginroom" method='POST' action="">
            {% csrf_token %}
                <input type="password" id="loginroompasswordid" name="loginroompassword" class = "form-control"
                value="Nhập Password Phòng" onfocus="this.value = '';"
                onblur="if (this.value == '') {this.value = 'Nhập Password Phòng';}" required="">
                <button type="submit" class="btn btn-primary" style="margin-top: 20px">Vào Phòng</button>
            </form>
        </div>
        
        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
        </div>
        
      </div>
    </div>
  </div>
{% endblock addmodal %}
{% block content %}
<div id="page-wrapper">
    <div class="inner-content">
        <div class="music-browse">
            <!--albums-->
            <!-- pop-up-box -->
            <link href="css/popuo-box.css" rel="stylesheet" type="text/css" media="all">
            <script src="js/jquery.magnific-popup.js" type="text/javascript"></script>
            <script>
                $(document).ready(function () {
                    $('.popup-with-zoom-anim').magnificPopup({
                        type: 'inline',
                        fixedContentPos: false,
                        fixedBgPos: true,
                        overflowY: 'auto',
                        closeBtnInside: true,
                        preloader: false,
                        midClick: true,
                        removalDelay: 300,
                        mainClass: 'my-mfp-zoom-in'
                    });
                });
            </script>
            <!--//pop-up-box -->

            <div class="browse">
                <div class="tittle-head two">
                    <h3 class="tittle">Phòng<span class="new">Của Bạn</span></h3>
                    <a href="browse.html">
                        <h4 class="tittle third">See all</h4>
                    </a>
                    <div class="clearfix"> </div>
                </div>
                <div class="bs-example bs-example-tabs" role="tabpanel" data-example-id="togglable-tabs">
                    <div id="myTabContent" class="tab-content">
                        <div role="tabpanel" class="tab-pane fade active in" id="home" aria-labelledby="home-tab">
                            <div class="browse-inner">
                                <!-- /agileits -->
                                {% for room in yourroom %}
                                <div class="col-md-3 artist-grid">
                                    <a href="/roomlisten/chat/{{room.name}}"><img src="https://picsum.photos/300/300" title="allbum-name"></a>
                                    <a href="/roomlisten/chat/{{room.name}}"><i class="glyphicon glyphicon-play-circle"></i></a>
                                    <a class="art" href="/roomlisten/chat/{{room.name}}">{{room.topic}}</a>
                                </div>
                                {% endfor %}
                                <div class="col-md-3 artist-grid">
                                    <a data-toggle="modal" data-target="#CreateRoomModal"><img
                                            src="https://picsum.photos/300/300" title="allbum-name"></a>
                                    <a href="#" data-toggle="modal" data-target="#CreateRoomModal"><i
                                            class=" glyphicon glyphicon-plus-sign"></i></a>
                                    <a class="art" data-toggle="modal" data-target="#CreateRoomModal">Thêm Phòng Mới</a>
                                </div>
                                <div class="clearfix"> </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /agileinfo -->
        </div>
        <!--//End-albums-->

        <!--//discover-view-->
        <div class="albums fourth">
            <div class="tittle-head two">
                <h3 class="tittle">Phòng<span class="new">Phòng Khác</span></h3>
                <a href="browse.html">
                    <h4 class="tittle third">See all</h4>
                </a>
                <div class="clearfix"> </div>
            </div>
            {% for room in otherroom %}
            <div class="col-md-3 artist-grid">
                <a href="#" onclick="CreateLinkToRoom('{{room.name}}','{{room.topic}}')" data-toggle="modal" data-target="#ModalLogin"><img src="https://picsum.photos/300/300" title="allbum-name"></a>
                <a href="#" onclick="CreateLinkToRoom('{{room.name}}','{{room.topic}}')" data-toggle="modal" data-target="#ModalLogin"><i class="glyphicon glyphicon-play-circle"></i></a>
                <a href="#" onclick="CreateLinkToRoom('{{room.name}}','{{room.topic}}')" data-toggle="modal" data-target="#ModalLogin">{{room.topic}}</a>
            </div>
            {% endfor %}
            <div class="clearfix"> </div>
        </div>
    </div>
    <!--//discover-view-->
    <!--//music-left-->
</div>
<!--body wrapper start-->
</div>
<div class="clearfix"></div>
<!--body wrapper end-->
<!-- /w3layouts-agile -->
</div>
<!--body wrapper end-->
</div>
{% endblock content %}

{% block script %}
<script>
    function CreateLinkToRoom(name, topic){
        $('#loginroom').attr('action', '/roomlisten/chat/'+name+'/');
        $('#loginroomtitle').text("Nhập Mật Khẩu Để Vào Phòng: " + topic); 
    }
</script>
<script>
    function CreateRoom(json, type) {
        roomname = json['roomname'];
        topic = json['topic'];
        const BrowseInner = document.querySelector(".browse-inner");
        const Ablums = document.querySelector(".albums");
        const Room = document.createElement("div");
        Room.classList.add("col-md-3", "artist-grid");

        const AImage = document.createElement("a");
        AImage.setAttribute("href", "/roomlisten/chat/" + roomname);
        const Image = document.createElement("img");
        Image.setAttribute("src", "https://picsum.photos/300/300");
        Image.setAttribute("title", "allbum-name");
        AImage.append(Image); //composite

        const AGlyphicon = document.createElement("a");
        AGlyphicon.setAttribute("href", "/roomlisten/chat/" + roomname);
        const Glyphicon = document.createElement("i");
        Glyphicon.classList.add("glyphicon", "glyphicon-play-circle");
        AGlyphicon.append(Glyphicon);

        const Art = document.createElement("a");
        Art.setAttribute("href", "/roomlisten/chat/" + roomname);
        Art.classList.add("art");
        Art.textContent = topic;

        Room.append(AImage, AGlyphicon, Art);
        if (type === 0) {
            BrowseInner.prepend(Room);
        } else {
            Ablums.prepend(Room);
        }
    }
    $(document).on('submit', '#createroomformid', function (e) {
        e.preventDefault();
        var roomname = document.forms["createroomformid"]["roomname"].value;
        var roompassword = document.forms["createroomformid"]["roompassword"].value;
        var topic = document.forms["createroomformid"]["topic"].value;
        if (roomname === 'Nhập Tên Phòng' || !/^[A-Za-z][A-Za-z0-9]+$/.test(roomname)) {
            alert("Tên phòng không hợp lệ");
            return false;
        }
        if (roomname === 'Nhập Password Phòng' || !/.{5}.+/.test(roompassword)) {
            alert("Password không hợp lệ");
            return false;
        }
        if (topic === 'Nhập Chủ Đề' || !/[ !@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(topic)) {
            alert("Chủ đề  không hợp lệ");
            return false;
        }
        $.ajax({
            type: 'POST',
            url: '/roomlisten/create/',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                roomname: roomname,
                topic: topic,
                password: roompassword,
            },
            success: function (e) {
                $('.close').trigger('click');

                var json = {
                    "roomname": roomname,
                    "topic": topic
                };
                CreateRoom(json, 0);

            },
            error: function (e) {
                alert('Phòng đã tồn tại');
            },
        });
    });
</script>
{% endblock script %}